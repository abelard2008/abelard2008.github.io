---
category: computer science and enginneering
layout: post
title: "borealis: install, run, understanding, change "
tags: [research, borealis, aurora]
---
{% include JB/setup %}

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">server 和 client</h2>
<div class="outline-text-2" id="text-1">
<p>
HeaderServer has a member global catalog, a client application commit
a network diagram to HeaderServer, then HeaderServer determines which
elements goes to which nodes and deploys them using the deploy method.
</p>

<p>
DataPath类中，EnqueueThread用于接收来自客户端的数据，and every
Borealis node only has one input and one output implemented by
DataPath.
</p>

<div class="org-src-container">

<pre class="src src-C++"><span class="linenr">1: </span><span style="color: #81a2be;">void</span>  <span style="color: #81a2be;">DataPath</span>::<span style="color: #81a2be;">EnqueueThread</span>::<span style="color: #de935f;">run</span>()
<span class="linenr">2: </span>{
<span class="linenr">3: </span>    <span style="color: #81a2be;">TCPAcceptor</span>&lt;DataHandler, <span style="color: #81a2be;">ptr</span>&lt;<span style="color: #81a2be;">DataHandler</span>::DHArgs&gt; &gt;
<span class="linenr">4: </span>                        <span style="color: #f0c674;">acceptor</span>(_data_loop,_data_add,args);
<span class="linenr">5: </span>
<span class="linenr">6: </span>}
</pre>
</div>
<p>
这里，TCPAcceptor的构造函数，最后调用NMSTL/net的
</p>
<div class="org-src-container">

<pre class="src src-C++"><span class="linenr"> 1: </span>    <span style="color: #81a2be;">TCPAcceptor</span>&lt;DataHandler, <span style="color: #81a2be;">ptr</span>&lt;<span style="color: #81a2be;">DataHandler</span>::DHArgs&gt; &gt;
<span class="linenr"> 2: </span>                        <span style="color: #de935f;">acceptor</span>(_data_loop,_data_add,args);
<span class="linenr"> 3: </span>{
<span class="linenr"> 4: </span>     <span style="color: #b5bd68;">if</span> (f &amp; acceptor) {
<span class="linenr"> 5: </span>                setsockopt_struct(SOL_SOCKET, SO_REUSEADDR, <span style="color: #81a2be;">int</span>(1));
<span id="coderef-bind" class="coderef-off"><span class="linenr"> 6: </span>                <span style="color: #b5bd68;">if</span> (bind(addr)) (bind)</span>
<span class="linenr"> 7: </span>                    listen();
<span class="linenr"> 8: </span>            } <span style="color: #b5bd68;">else</span> {
<span id="coderef-connect" class="coderef-off"><span class="linenr"> 9: </span>                connect(addr); (connect)</span>
<span class="linenr">10: </span>            }
<span class="linenr">11: </span>
<span class="linenr">12: </span>}
</pre>
</div>
<p>
很明显，line <a href="#coderef-bind"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-bind');" onmouseout="CodeHighlightOff(this, 'coderef-bind');">bind</a> 创建服务器，line <a href="#coderef-connect"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-connect');" onmouseout="CodeHighlightOff(this, 'coderef-connect');">connect</a> 创建客户端，在borealis
的服务器和客户端都是在这里建立的。
</p>

<p>
在AdminCatalog.cc中的QueryProcessor::add_xml_string(),当该string为head
标签时，则调用QueryProcessor::add_head_element(), 进而
</p>
<div class="org-src-container">

<pre class="src src-C++">_head_client = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">UpdateClient</span>(InetAddress(endpoint), <span style="color: #8abeb7;">"BigGiantHead"</span>);
</pre>
</div>
<p>
UpdateClient调用上面的line <a href="#coderef-connect"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-connect');" onmouseout="CodeHighlightOff(this, 'coderef-connect');">connect</a> 将borealis节点自己称为
BigGiantHead的客户端，与其进行查询网络文件的交互，端口为35000。
</p>

<p>
在两个query位于不同的borealis节点时，upstream节点作为downstream节点的
publisher，因此在AdminCatolog.cc中的
QueryProcessor::subscribe_streams(),进而调用：
</p>
<div class="org-src-container">

<pre class="src src-C++"><span style="color: #81a2be;">void</span>  <span style="color: #81a2be;">DataPath</span>::<span style="color: #de935f;">add_output_path_client</span>(<span style="color: #81a2be;">CatalogSubscription</span> <span style="color: #f0c674;">sub</span>)
{
 <span style="color: #81a2be;">ptr</span>&lt;DataHandler&gt;  <span style="color: #f0c674;">dh</span>(<span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">DataHandler</span>(_fast_dequeue_fwd._data_fwd_loop,
                                             TCPSocket(endpoint,
                                                       <span style="color: #81a2be;">Socket</span>::nonblocking),
                                             args));
<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">endpoint&#20026;downstream&#33410;&#28857;&#30340;ip&#22320;&#22336;</span>
}
</pre>
</div>
<p>
downstream节点也作为upstream节点的subscriber，其构建过程是从分析xml开始的，因此其调用堆栈为：
</p>

<pre class="example">
BasicComponent::endpoint_for()
BasicComponent::proxy_for()
BasicComponent::qp_for()
QueryProcessor::request_replicas()
QueryProcessor::local_add_subscriptions()
QueryProcessor::add_input_element()
QueryProcessor::add_xml_string()
</pre>

<p>
在应用程序端，如test/simple/mytestdist，首先需要创建一个MedusaClient，
并设置用于接收结果的处理程序：
</p>
<div class="org-src-container">

<pre class="src src-C++">_client = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">MedusaClient</span>(InetAddress());

<span style="color: #81a2be;">Status</span>  <span style="color: #f0c674;">status</span> = _client-&gt;set_data_handler(
                                 InetAddress(<span style="color: #81a2be;">Util</span>::form_endpoint(MYTESTDIST_ENDPOINT,
                                                                 DEFAULT_MONITOR_PORT)),
                                 wrap(&amp;outputHandler));
</pre>
</div>
<p>
调用set_data_handler()后，进而调用NMSTL/net的Socket来将自己设置为服务
器端，端口为25000。
</p>

<p>
其次，为了提交和修改网络查询图，创建一个HeadClient，将自己设计成BigGiantHead的客户端，端口为
35000。
</p>

<p>
最后，为了流数据输入到某个Borealis节点，这个节点是查询网络中的首节点，
需要将自己创建为客户端：
</p>
<div class="org-src-container">

<pre class="src src-C++"><span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span>_client-&gt;set_data_path(MAX_BUFFER, <span style="color: #81a2be;">Util</span>::get_host_address(<span style="color: #8abeb7;">"127.0.0.1"</span>), 15000))
    {   ERROR &lt;&lt; <span style="color: #8abeb7;">"Failed setting data path"</span>;
    }
    <span style="color: #b5bd68;">else</span>
    {   DEBUG &lt;&lt; <span style="color: #8abeb7;">"Set data path"</span>;

        _eventPacket = <span style="color: #81a2be;">ptr</span>&lt;StreamEvent&gt;(<span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">StreamEvent</span>(PACKET));
        _eventPacket-&gt;_inject = <span style="color: #81a2be;">true</span>;
    }
</pre>
</div>
<ul class="org-ul">
<li>python 版本 2.3
</li>
</ul>
<p>
由于执行 demo/sigmod2005/cube/bot_src 目录下的setup过程中，python脚本
无法在FC12原始python版本下，有错误，下载python2.3的源码，编译
</p>
<pre class="example">
 cd /home/borealis/packages/Python-2.3
./configure --prefix=/home/borealis/builtTools/python/
make
make install
# 临时使用python，将原始/usr/bin/python重命名为python.bak
export PATH=$PATH:/home/borealis/builtTools/python/bin
</pre>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">运行demo中的cube</h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="http://cubeengine.com/cube.php4">cube</a> 是早期的第一人称射击游戏，现在的名称是<a href="http://assault.cubers.net/">AssaultCube</a>, 代码开源（被用
在布朗大学的 <a href="http://cs.brown.edu/courses/cs138/old/2006/">网络信息系统课程作业</a> 中）。Borealis为了演示，修改了<a href="http://filebase.bots-united.com/index.php?act=category&id=39">Cube
Bot version 0.2</a> <sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>的源
代码，使得Borealis作为Cube引擎的一个服务器组件，在多人游戏中，游戏团队
的管理者可以注册连续查询服务，随时跟踪团队信息，以调整游戏策略。
</p>

<p>
无法知道Borealis所使用的cube源代码版本。Borealis在2005的SIGMOD上发表了
<a href="http://localhost:4000/reference/streamprocessing/sigmod05.demo.pdf">Distributed Operation in the Borealis Stream Processing Engine</a>, 并没有
描述是在borealis的哪个版本中运行的诸多细节，根据demo/sigmod2005/cube/
目录下的README说明，直接进行编译，无法通过，需要修改几处脚本文件和源代
码； 关于运行的指令也不是完全正确，需要做一些调整。
</p>

<ul class="org-ul">
<li>运行环境： 2.6.31.5-127.fc12.i686.PAE
</li>

<li>要求安装的SDL包有：
</li>
</ul>
<pre class="example">
SDL-devel-1.2.13-12.fc12.i686
SDL_mixer-1.2.8-13.fc12.i686
SDL-1.2.13-12.fc12.i686
SDL_mixer-devel-1.2.8-13.fc12.i686
SDL_image-devel-1.2.7-1.fc12.i686
SDL_image-1.2.7-1.fc12.i686
</pre>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">初始编译</h3>
<div class="outline-text-3" id="text-2-1">
<p>
根据demo/sigmod2005/cube/README中的说明，
</p>
<pre class="example">
Platform:
        Linux 2.6x or 2.4x kernels with gcc-3.2 or higher.

Dependencies:

        (1) Borealis
        (2) NMSTL (/pro/sand/software/NMSTL)
        (3) SDL 1.2.7
        (4) SDL-mixer 1.2.5
        (5) SDL-image 1.2.3
        (6) xercesc 2.3.0
        (7) OpenGL, GLU

Compiling:
        (1) Setup and compile borealis includeing the tests, we use the version in subversion repository
        here: file:///pro/sand/games/svn/borealis/trunk borealis

        (2) Get the cube source code from subversion (file:///pro/sand/games/svn/cube/trunk) or get the tarfile.

        (3) cd cube/source/src

        (4) run ./setup
        (5) run configure e.g.,
        export SANDSOFT=/pro/sand/software
</pre>

<p>
安装SDL版本有所不同，不影响编译。上面/Compiling/ 下的(1)(2)(3)描述的都
与下载的borealis不一致，(2)中的cube可以直接使用
demo/sigmod2005/cube/bot_src下的源代码，(3)的路径应该
为:demo/sigmod2005/cube/bot_src。另外执行(5)之前，需要修改configure文
件中SDL相关的的路径：由原来的
</p>
<pre class="example">
with_sdl_mixer=/usr/local
</pre>
<p>
改为：
</p>
<pre class="example">
with_sdl_mixer=/usr
</pre>
<p>
最终执行的操作如下：
</p>
<pre class="example">
cd demo/sigmod2005/cube/bot_src
./setup
./configure --with-xercesc=/home/borealis/builtTools/xerces --with-nmstl=/home/borealis/install_nmstl --with-borealis=/home/borealis/borealis
make
</pre>

<p>
make的时候，会遇到如下错误和修改：
</p>
<ul class="org-ul">
<li>错误一
</li>
</ul>
<pre class="example">
bot_util.h: In member function ‘bool TMultiChoice&lt;C&gt;::GetSelection(C&amp;)’:
bot_util.h:539: 错误：‘pNode’ 在此作用域中尚未声明

bot_util.h: In member function ‘bool TMultiChoice&lt;C&gt;::GetSelection(C&amp;) [with C = char*]’:
bot.cpp:1151:   instantiated from here
bot_util.h:539: 错误：依赖名 ‘TLinkedList&lt;TMultiChoice&lt;C&gt;::SMultiChoice*&gt;::node_s’ 被解析为非类型，但实例化却产生了一个类型
bot_util.h:539: 附注：如果您想指定类型，请使用 ‘typename TLinkedList&lt;TMultiChoice&lt;C&gt;::SMultiChoice*&gt;::node_s’
make[2]: *** [bot.o] 错误 1
make[2]: Leaving directory `/home/borealis/borealis/demo/sigmod2005/cube/bot_src/src'
make[1]: *** [all-recursive] 错误 1
make[1]: Leaving directory `/home/borealis/borealis/demo/sigmod2005/cube/bot_src'
make: *** [all] 错误 2
</pre>
<p>
将bot_util.h的539行：
</p>
<pre class="example">
539 TLinkedList&lt;SMultiChoice*&gt;::node_s *pNode = pChoiceList-&gt;GetFirst();
</pre>
<p>
改为：
</p>
<pre class="example">
539 typename TLinkedList&lt;SMultiChoice*&gt;::node_s *pNode = pChoiceList-&gt;GetFirst();
</pre>
<ul class="org-ul">
<li>错误二
</li>
</ul>
<pre class="example">
/home/borealis/builtTools/gcc/lib/gcc/i686-pc-linux-gnu/4.1.1/../../../../include/c++/4.1.1/bits/fstream.tcc: In member function ‘virtual typename std::basic_filebuf&lt;_CharT, _Traits&gt;::int_type std::basic_filebuf&lt;_CharT, _Traits&gt;::underflow()’:
/home/borealis/builtTools/gcc/lib/gcc/i686-pc-linux-gnu/4.1.1/../../../../include/c++/4.1.1/bits/fstream.tcc:289: 错误：expected unqualified-id before ‘(’ token
/home/borealis/builtTools/gcc/lib/gcc/i686-pc-linux-gnu/4.1.1/../../../../include/c++/4.1.1/bits/fstream.tcc: In member function ‘virtual std::streamsize std::basic_filebuf&lt;_CharT, _Traits&gt;::xsputn(const _CharT*, std::streamsize)’:
/home/borealis/builtTools/gcc/lib/gcc/i686-pc-linux-gnu/4.1.1/../../../../include/c++/4.1.1/bits/fstream.tcc:612: 错误：expected unqualified-id before ‘(’ token
make[2]: *** [bot.o] 错误 1
make[2]: Leaving directory `/home/borealis/borealis/demo/sigmod2005/cube/bot_src/src'
make[1]: *** [all-recursive] 错误 1
make[1]: Leaving directory `/home/borealis/borealis/demo/sigmod2005/cube/bot_src'
make: *** [all] 错误 2
</pre>
<p>
fstream.tcc:289的内容为： 
</p>
<pre class="example">
/home/borealis/builtTools/gcc/include/c++/4.1.1/bits/fstream.tcc 289行的内容为：
__ilen = std::min(__avail, __buflen);
</pre>
<p>
在bot_src/src/tools.h中定义了
</p>
<pre class="example">
#define max(a,b) (((a) &gt; (b)) ? (a) : (b))
#define min(a,b) (((a) &lt; (b)) ? (a) : (b))
</pre>
<p>
因此是因为名称相同造成的，修改成其它的名称即可。
</p>

<ul class="org-ul">
<li>错误三
</li>
</ul>
<pre class="example">
gamesubscriber.h: In constructor ‘GameSubscriber::GameSubscriber(NMSTL::InetAddress, NMSTL::InetAddress, NMSTL::InetAddress, NMSTL::ptr&lt;std::vector&lt;NMSTL::ptr&lt;BufferedSocket&gt;, std::allocator&lt;NMSTL::ptr&lt;BufferedSocket&gt; &gt; &gt; &gt;)’:
gamesubscriber.h:133: 错误：用作消歧义的 ‘template’ 只能用于模板内
tools.h: In constructor ‘vector&lt;T&gt;::vector()’:
tools.h:148: 警告：‘gp’ 的实参不依赖模板参数，所以 ‘gp’ 的声明必须可用
tools.h: In constructor ‘hashtable&lt;T&gt;::hashtable()’:
tools.h:223: 警告：‘gp’ 的实参不依赖模板参数，所以 ‘gp’ 的声明必须可用
make[2]: *** [client.o] 错误 1
</pre>
<p>
g++-4.1.1不允许在构造函数中初始化动态变量，而gamesubscriber.h:133行，
在构造函数内，有下面的语句：
</p>
<pre class="example">
file name: gamesubscriber.h
133 m_deploy_qp = m_deploy_endpoint.template get&lt;Borealis::QueryProcessor&gt;("QueryProcessor");
</pre>
<p>
因此注释掉该行内容，并且可以在以后使用的时候，对其进行初始化，将该行移
到gamesubscriber.cpp的355行第一次使用m_deploy_qp的前面:
</p>
<pre class="example">
file name: gamesubscriber.cpp
354  m_deploy_qp = m_deploy_endpoint.template get&lt;Borealis::QueryProcessor&gt;("QueryProcessor");
355    if ( !m_deploy_qp ) {
356        WARN &lt;&lt; "No Borealis node selected for deploying queries.";
357        return false;
358    }
</pre>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">最后四个错误</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>上面的步骤后，还是不能正常运行，由于borealis源代码中有一个错误：
</li>
</ul>
<div class="org-src-container">

<pre class="src src-C++"><span class="linenr"> 1: </span><span style="color: #81a2be;">file</span> <span style="color: #de935f;">name</span>: tool/head/DeployDiagram.cc
<span class="linenr"> 2: </span>Status  <span style="color: #81a2be;">DeployDiagram</span>::<span style="color: #de935f;">deploy_table_schema</span>(<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Target node in _pending.</span>
<span class="linenr"> 3: </span>                                           <span style="color: #81a2be;">string</span>   <span style="color: #f0c674;">endpoint</span>)
<span class="linenr"> 4: </span>{
<span class="linenr"> 5: </span>    <span style="color: #81a2be;">CatalogTable</span>   *<span style="color: #f0c674;">table</span>;
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span>    <span style="color: #81a2be;">TableMap</span>::<span style="color: #81a2be;">iterator</span>  <span style="color: #f0c674;">table_it</span>;
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>    <span style="color: #b5bd68;">for</span> (table_it  = _topology._table_map.begin();
<span id="coderef-table" class="coderef-off"><span class="linenr">10: </span>         table_it != _topology._table_map.end(); ++table)</span>
</pre>
</div>
<p>
line <a href="#coderef-table"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-table');" onmouseout="CodeHighlightOff(this, 'coderef-table');">10</a> 的初始化和条件变量为table_it，而增量变量为table，导致该循
环无法退出。
</p>
<ul class="org-ul">
<li>netio.cpp 的宕机
</li>
</ul>
<div class="org-src-container">

<pre class="src src-C++"><span class="linenr">1: </span><span style="color: #81a2be;">void</span> <span style="color: #de935f;">handle_incoming_tuples</span>()
<span class="linenr">2: </span>{
<span class="linenr">3: </span>   <span style="color: #81a2be;">ptr</span>&lt;StreamEvent&gt; <span style="color: #f0c674;">evt</span>(<span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">StreamEvent</span>());
<span class="linenr">4: </span>
<span class="linenr">5: </span>          <span style="color: #b5bd68;">if</span> (handler_it != handler_end) {
<span id="coderef-assert" class="coderef-off"><span class="linenr">6: </span>              assert(evt-&gt;_tuple_size == handler_it-&gt;second.first); (assert)</span>
<span class="linenr">7: </span>  ...
<span class="linenr">8: </span>}
</pre>
</div>
<p>
line <a href="#coderef-assert"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-assert');" onmouseout="CodeHighlightOff(this, 'coderef-assert');">assert</a> 现在的borealis版本并不处理_tuple_size，因此它的值为0，导
致这个断言永远失败，必须注释掉。
</p>
<ul class="org-ul">
<li>to_server_map 引发的错误
</li>
</ul>
<p>
在cube.xml中有个字段定义：
</p>
<pre class="example">
&lt;field name="to_server_map"        type="string"  size="131"/&gt;
</pre>
<p>
但是实际的值为131，导致运行失败。
</p>
<ul class="org-ul">
<li>metl3.cgz引发的错误
</li>
</ul>
<p>
cube_client启动的时候，需要读取metl3.cgz,因此需要将cube的packages.tar，
解压到cube目录下。
</p>

<p>
通过比对 AssaultCube，应该是其早期的版本
</p>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">运行cube</h3>
<div class="outline-text-3" id="text-2-3">
<p>
在上一步编译中，执行cube/bot\unser{}src/setup后，会在cube目录下生成
run_cube_demo.sh文件，此文件跟borealis中其它如test/simple下的runtest文
件类似。从文件的game目标所列出的主要组合命令挨个分析：
</p>


<div class="org-src-container">

<pre class="src src-sh"><span class="linenr"> 1: </span>game
<span id="coderef-file" class="coderef-off"><span class="linenr"> 2: </span>        read_game_hosts $<span style="color: #f0c674;">2</span></span>
<span class="linenr"> 3: </span>
<span id="coderef-clean" class="coderef-off"><span class="linenr"> 4: </span>        $<span style="color: #f0c674;">0</span> clean</span>
<span id="coderef-cls" class="coderef-off"><span class="linenr"> 5: </span>        $<span style="color: #f0c674;">0</span> cls</span>
<span class="linenr"> 6: </span>        sleep 1
<span id="coderef-mp" class="coderef-off"><span class="linenr"> 7: </span>        $<span style="color: #f0c674;">0</span> metaoptimizer</span>
<span class="linenr"> 8: </span>        sleep 3
<span class="linenr"> 9: </span>        $<span style="color: #f0c674;">0</span> borealis
<span class="linenr">10: </span>        sleep 3
<span class="linenr">11: </span>
<span class="linenr">12: </span>        <span style="color: #b5bd68;">for</span> ip<span style="color: #b5bd68;"> in</span> ${<span style="color: #f0c674;">HOSTS</span>}; <span style="color: #b5bd68;">do</span>
<span id="coderef-remote" class="coderef-off"><span class="linenr">13: </span>            env <span style="color: #f0c674;">CLS_IP</span>=${<span style="color: #f0c674;">IP</span>} <span style="color: #f0c674;">IP</span>=<span style="color: #8abeb7;">"$ip"</span> ${<span style="color: #f0c674;">EXEC</span>} bremote</span>
<span class="linenr">14: </span>        <span style="color: #b5bd68;">done</span>
<span class="linenr">15: </span>        sleep 25
<span class="linenr">16: </span>
<span id="coderef-head" class="coderef-off"><span class="linenr">17: </span>        $<span style="color: #f0c674;">0</span> head</span>
<span class="linenr">18: </span>        sleep 3
<span id="coderef-viz" class="coderef-off"><span class="linenr">19: </span>        $<span style="color: #f0c674;">0</span> gui-viz</span>
<span class="linenr">20: </span>        <span style="color: #b5bd68;">exit</span> 0
<span class="linenr">21: </span>        ;;
</pre>
</div>
<ul class="org-ul">
<li>line <a href="#coderef-file"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-file');" onmouseout="CodeHighlightOff(this, 'coderef-file');">2</a>  可以给出包含游戏主机ip地址的文件，通过<a href="#coderef-remote"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-remote');" onmouseout="CodeHighlightOff(this, 'coderef-remote');">13</a> 行和
bremote所执行的命令知道，这些主机上将会启动borealis引擎。
</li>
<li>line <a href="#coderef-clean"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-clean');" onmouseout="CodeHighlightOff(this, 'coderef-clean');">4</a> 删除一些以前运行的日志文件
</li>
<li>line <a href="#coderef-cls"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-cls');" onmouseout="CodeHighlightOff(this, 'coderef-cls');">5</a> 与README文件中描述的“start the central lookup server”一
致，但是在这个borealis版本中，并没有CentralLookupServer相关的源代码，
在Makefile的一些注释中，发现些痕迹，并且从test下能运行的例子以及开
发文档中，并不需要CentralLookupServer。应该是以前版本中的组件。接下
来，<a href="#coderef-mp"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-mp');" onmouseout="CodeHighlightOff(this, 'coderef-mp');">7</a> 行中的metaoptimizer一样的被去掉了，由NHOptimizer代替。
</li>
<li>line <a href="#coderef-head"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-head');" onmouseout="CodeHighlightOff(this, 'coderef-head');">17</a> 提交网络和网络布局文件到borealis节点。
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sh">xterm -T BigGiantHead -geometry 80x20+20+50 -e env <span style="color: #f0c674;">LD_LIBRARY_PATH</span>=${<span style="color: #f0c674;">LD_LIBRARY_PATH</span>} sh -c <span style="color: #8abeb7;">"${BOREALIS_HEAD_HOME}/BigGiantHead ${QUERY_FILE} ${DEPLOY_FILE} 2&gt;&amp;1 | tee head.log"</span> &amp;
</pre>
</div>
<p>
这行命令直接将两个文件cube.xml和cube_deployment.xml提交到
borealis节点，但是现有的test/simple下的mytestdist和
test/composite/sunion/都是专门写一个函数如launchDiagram()，主要代码如下：
</p>
<div class="org-src-container">

<pre class="src src-C++"><span class="linenr"> 1: </span>client = (<span style="color: #81a2be;">HeadClient</span> *)<span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">HeadClient</span>( InetAddress( HEAD_NODE,
<span class="linenr"> 2: </span>                                                    DEFAULT_HEAD_PORT ));
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span style="color: #81a2be;">string</span> <span style="color: #f0c674;">query_file</span>        = <span style="color: #8abeb7;">"cube.xml"</span>;
<span class="linenr"> 5: </span><span style="color: #81a2be;">string</span> <span style="color: #f0c674;">deployment_file</span>   = <span style="color: #8abeb7;">"cube_deployment.xml"</span>;
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span>rpc = client-&gt;deploy_xml_file( query_file);
<span class="linenr"> 8: </span><span style="color: #b5bd68;">if</span> ( <span style="color: #81a2be;">!</span> rpc.valid() )
<span class="linenr"> 9: </span>{
<span class="linenr">10: </span>    WARN &lt;&lt; <span style="color: #8abeb7;">"Error with query file "</span> &lt;&lt; rpc.stat();
<span class="linenr">11: </span>    exit(0);
<span class="linenr">12: </span>}
<span class="linenr">13: </span>
<span class="linenr">14: </span>rpc = client-&gt;deploy_xml_file(deployment_file);
<span class="linenr">15: </span><span style="color: #b5bd68;">if</span> ( <span style="color: #81a2be;">!</span> rpc.valid() )
<span class="linenr">16: </span>{
<span class="linenr">17: </span>    WARN &lt;&lt; <span style="color: #8abeb7;">"Error with deployment file "</span> &lt;&lt; rpc.stat();
<span class="linenr">18: </span>    exit(0);
<span class="linenr">19: </span>}
</pre>
</div>
<p>
因此原始的命令head也不能正确执行，将上面的c++代码生成deploy命令，并将
head的命令改成
</p>
<div class="org-src-container">

<pre class="src src-sh">xterm -T BigGiantHead -geometry 80x20+20+50 -e env <span style="color: #f0c674;">LD_LIBRARY_PATH</span>=${<span style="color: #f0c674;">LD_LIBRARY_PATH</span>} sh -c <span style="color: #8abeb7;">"${BOREALIS_HEAD_HOME}/BigGiantHead  2&gt;&amp;1 | tee head.log"</span> &amp;
</pre>
</div>

<ul class="org-ul">
<li>line <a href="#coderef-viz"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-viz');" onmouseout="CodeHighlightOff(this, 'coderef-viz');">19</a> 没有准备运行
</li>
<li>最简单的运行，只用一个borealis节点，那么剩下的game代码如下
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sh"><span class="linenr">1: </span>game
<span class="linenr">2: </span>        $<span style="color: #f0c674;">0</span> borealis 127.0.0.1:15000
<span class="linenr">3: </span>        sleep 3
<span class="linenr">4: </span>
<span class="linenr">5: </span>        $<span style="color: #f0c674;">0</span> head
<span class="linenr">6: </span>        sleep 3
<span class="linenr">7: </span>        <span style="color: #b5bd68;">exit</span> 0
<span class="linenr">8: </span>        ;;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">完整运行cube+borealis的步骤</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>在一个终端运行
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">cd</span> demo/sigmod2005/cube
./run_cube_demo game
</pre>
</div>
<ul class="org-ul">
<li>等到borealis节点和head都启动后，在另一个终端运行deploy命令：
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">cd</span> demo/sigmod2005/cube/bot_src/src
./deploy
</pre>
</div>
<p>
注： BigGiantHead收到远端提交命令后，只接收需要的文件名如这里的
cube.xml和cube_deployment.xml，然后在当前运行BigGiantHead的目录
下找相应的文件，因此这里需要将cube/bot_src/borealis_if目录
下的两个xml文件拷贝到demo/sigmod2005/cube目录下，否则得到读文件失败的
信息。
</p>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">compile borealis i386 in FC20.x86_64</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>config files
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sh">diff -r borealis/src/configure.ac borealis-ok/src/configure.ac
14,15c14,15
&lt; <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror"</span>
&lt; <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror"</span>
---
&gt; <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror -m32"</span>
&gt; <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror -Wno-deprecated -m32"</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">diff -r borealis/test/configure.ac borealis-ok/test/configure.ac
14,15c14,15
&lt; <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror"</span>
&lt; <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror"</span>
---
&gt; <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror -m32"</span>
&gt; <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror -m32"</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">diff -r borealis/tool/configure.ac borealis-ok/tool/configure.ac
14,15c14,15
&lt; <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror"</span>
&lt; <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror"</span>
---
&gt; <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror -m32"</span>
&gt; <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror -m32"</span>
</pre>
</div>
<div class="org-src-container">

<pre class="src src-sh"></pre>
</div>
<div class="org-src-container">

<pre class="src src-sh">diff -r borealis/utility/client/configure.ac borealis-fc20/utility/client/configure.ac
14,15c14,15
&lt; <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror"</span>
&lt; <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror"</span>
---
&gt; <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror -m32"</span>
&gt; <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-g -Wall -Werror -m32"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">visual viewer</h2>
<div class="outline-text-2" id="text-4">
<p>
Up to now, I verified whether these visual montors with Java were able
to run.
</p>

<ul class="org-ul">
<li>tool/viewer
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sh">[borealis@localhost viewer]$ ant run
</pre>
</div>

<p>
it will run a GUI, it can load network query, such as fauttest.xml, in
Editor option, the network appears.
</p>

<ul class="org-ul">
<li>tool/monitor
</li>
</ul>
<p>
after simply running make cmd, monitor.jar is produced in lib, for
testing this monitor:
</p>
<div class="org-src-container">

<pre class="src src-sh">[borealis@localhost monitor]$ java -cp ./lib/ha.jar:./lib/monitor.jar:./lib/clientApi.jar:./lib/medusaXmlRpc.jar:./lib/xerces.jar ../../demo/ha/ha_config.xml
</pre>
</div>

<p>
the last argument is necessary, and it should be another file that
must include item "layout".
the above cmd will start a window. the concrete details are not clear.
</p>

<p>
ha.jar in the above cmd, it includes two files CountSchema.java and
PacketSchema.java. For getting ha.jar:
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">cd</span> utility/unix
[borealis@localhost unix]$ ./build.borealis.sh -demo ;CountSchema.java and PacketSchema.java will be compiled.
<span style="color: #b294bb;">cd</span> ../../demo/ha
[borealis@localhost ha]$ jar cvf ./ha.jar ./*.class
</pre>
</div>

<ul class="org-ul">
<li>tool/statsView
</li>
</ul>
<p>
this tool is used in [balazinska06]<sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup>'s Figure 5-4. It can be
produced by make under tool/statsView, and:
</p>

<div class="org-src-container">

<pre class="src src-sh">java -cp ./lib/monitor.jar monitor.Monitor 127
</pre>
</div>

<p>
the last arg need more study.
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">AvailabilityMonitor</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #de935f;">monitor_nodes</span>() {
...
    <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Re-scheduling monitoring task</span>
    (<span style="color: #81a2be;">new</span> <span style="color: #f0c674;">CallbackTimer</span>(_my_loop,wrap(this,&amp;AvailabilityMonitor::monitor_nodes)))-&gt;arm(Time::now() + Time::msecs(_ping_interval));

}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">ConsistencyMgr</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-c++"><span style="color: #81a2be;">void</span> <span style="color: #81a2be;">ConsistencyMngr</span>::<span style="color: #de935f;">update_state</span>(<span style="color: #81a2be;">ConsistencyState</span> <span style="color: #f0c674;">new_state</span>)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #81a2be;">Status</span> <span style="color: #81a2be;">ConsistencyMngr</span>::<span style="color: #de935f;">handle_control_tuples</span>(<span style="color: #81a2be;">ptr</span>&lt;StreamEvent&gt; <span style="color: #f0c674;">event</span>)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #b5bd68;">typedef</span> <span style="color: #81a2be;">map</span>&lt;<span style="color: #81a2be;">string</span>, <span style="color: #81a2be;">set</span>&lt;<span style="color: #81a2be;">string</span>&gt; &gt; <span style="color: #81a2be;">ReplicaMap</span>;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">Configuration of the query diagram.</span>
<span style="color: #969896; font-style: italic;">///</span>
<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">Topology</span>
{
    <span style="color: #81a2be;">CatalogSchema</span>::<span style="color: #81a2be;">SchemaMap</span>    <span style="color: #f0c674;">_schema_map</span>;       <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Tuple Description</span>
    <span style="color: #81a2be;">StreamMap</span>       <span style="color: #f0c674;">_stream_map</span>;       <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Stream</span>
    <span style="color: #81a2be;">BoxMap</span>          <span style="color: #f0c674;">_box_map</span>;          <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Box</span>
    <span style="color: #81a2be;">TableMap</span>        <span style="color: #f0c674;">_table_map</span>;        <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Tables</span>
    <span style="color: #81a2be;">QueryMap</span>        <span style="color: #f0c674;">_query_map</span>;        <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Queries - Move to DeployDiagram.</span>
};
</pre>
</div>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Network oriented approach to inter-site connections.</span>
<span style="color: #b5bd68;">typedef</span>   <span style="color: #81a2be;">map</span>&lt;Name, CatalogSubscription&gt;            <span style="color: #81a2be;">SubscriptionMap</span>;
<span style="color: #b5bd68;">typedef</span>   <span style="color: #81a2be;">map</span>&lt;InetAddress, <span style="color: #81a2be;">SubscriptionMap</span>&gt;         <span style="color: #81a2be;">StreamLinkMap</span>;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">xml rpc</span>
<span style="color: #b294bb;">#define</span> <span style="color: #f0c674;">XML_RPC_PORT_OFFSET</span> 1

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Fast data path</span>
<span style="color: #b294bb;">#define</span> <span style="color: #f0c674;">DATA_PORT_OFFSET</span> 2
</pre>
</div>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">medusa_components</span>
{
    <span style="color: #81a2be;">IOEventLoop</span>             &amp;<span style="color: #f0c674;">_loop</span>;
    <span style="color: #81a2be;">InetAddress</span>              <span style="color: #f0c674;">_addr</span>;
<span style="color: #969896; font-style: italic;">//    </span><span style="color: #969896; font-style: italic;">ptr&lt;HA&gt;                   _ha;</span>
    <span style="color: #81a2be;">ptr</span>&lt;AvailabilityMonitor&gt;  <span style="color: #f0c674;">_avail_mon</span>;
    <span style="color: #81a2be;">ptr</span>&lt;LocalLoadShedder&gt;     <span style="color: #f0c674;">_local_ls</span>;
    <span style="color: #81a2be;">ptr</span>&lt;NHLoadShedder&gt;        <span style="color: #f0c674;">_nh_ls</span>;
    <span style="color: #81a2be;">ptr</span>&lt;NHOptimizer&gt;          <span style="color: #f0c674;">_nhopt</span>;
    <span style="color: #81a2be;">ptr</span>&lt;QOSOptimizer&gt;         <span style="color: #f0c674;">_qosopt</span>;
    <span style="color: #81a2be;">ptr</span>&lt;QueryProcessor&gt;       <span style="color: #f0c674;">_qp</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">SUnionQBox</h2>
<div class="outline-text-2" id="text-7">
<p>
For FT, SUnionQBox creates a Bucket per 500 millseconds, all inputing
tuples with different timestamp will be taken into different buckets
according the code:
</p>

<div class="org-src-container">

<pre class="src src-c++">millseconds = tuple_timestamp.to_millseconds()/500

interval_nb = timestamp_to_interval_nb(tuple_timestamp) 


<span style="color: #b5bd68;">typedef</span> <span style="color: #81a2be;">map</span>&lt;<span style="color: #81a2be;">long</span> <span style="color: #81a2be;">long</span>, <span style="color: #81a2be;">ptr</span>&lt;Bucket&gt; &gt; <span style="color: #81a2be;">Buckets</span>;

<span style="color: #81a2be;">Buckets</span> <span style="color: #f0c674;">_buckets</span>;
</pre>
</div>
<p>
interval_nb is used as _buckets' key, when getting a new tuple,
SUnionQBox first looks up a bucket from _buckets based on interval_nb,
and inserts the new tuple into the bucket, or creates a new bucket and
inserts the tuple into it.
</p>


<p>
dst_tuple.set_tuple_type(TupleType::UNDO) &lt;- SControlQBox::emit_undo_tuple(const Tuple&amp; src_tuple) &lt;-
SOutputQBox::unpack_state()&lt;- recovery_task::perform_task()  
</p>

<p>
SUnionBoxNoBucketState -&gt; AbstractBoxState
</p>

<p>
SControlQBox::emit_undo_tuple()[set_tuple_type(TupleType::UNDO]&lt;-
SOutputQBox::unpack_state() &lt;- AuroraNode::recover() &lt;-
ConsistencyMgr::launch_reconciliation() &lt;-
ConsistencyMgr::request_authorization_response() &lt;-
ConsistencyMgr::request_authorization()[if type == TupleType::RECONCILIATION_REQUSET] &lt;-
ConsistencyMgr::handle_control_tuples() &lt;-
ConsistencyMgr::monitor_control_stream()[
_qp._data_path.add_local_output_path_client(control_stream_name,
wrap(this,&amp;ConsistencyMngr::handle_control_tuples));] 
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
In video games, a bot is a type of weak AI expert system
software which for each instance of the program controls a player in
deathmatch, team deathmatch and/or cooperative human player, most
prominently in the first-person shooters (FPSs)。
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
Fault-Tolerance and Load Management in a Distributed Stream Processing System.
Magdalena Balazinska. PhD dissertation.
</p></div>


</div>
</div>
